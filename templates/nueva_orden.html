{% extends 'base.html' %}
{% block contenido %}
<div class="container py-4">
  <h2 class="text-center mb-4">ğŸ§ª Nueva Orden de Trabajo</h2>

  <form method="POST" action="{{ url_for('ordenes.nueva_orden') }}">
    <!-- Productor (ya seleccionado) -->
    <div class="mb-3">
      <label class="form-label">ğŸ‘¤ Productor</label>
      <input type="text" class="form-control form-control-lg" value="{{ productor.nombre }} â€” CUIT: {{ productor.cuit }}" disabled>
      <input type="hidden" name="productor_id" value="{{ productor.id }}">
    </div>

    <!-- Campo y Lote -->
    <div class="col-12 mb-3">
      <label for="campo" class="form-label">ğŸŒ¾ Nombre del Campo</label>
      <input type="text" name="campo" id="campo" class="form-control form-control-lg" placeholder="Ej: Campo Norte, La Esperanza" required>
    </div>

    <div class="col-12 mb-3">
      <label for="lote" class="form-label">ğŸ“ Nombre o NÃºmero de Lote</label>
      <input type="text" name="lote" id="lote" class="form-control form-control-lg" placeholder="Ej: Lote A, Lote 1, Soja" required>
    </div>

    <!-- Fechas -->
    <div class="row">
      <div class="col-12 mb-3">
        <label for="fecha_inicio" class="form-label">ğŸ“… Fecha de Inicio del Trabajo *</label>
        <input type="date" name="fecha_inicio" id="fecha_inicio" class="form-control form-control-lg" required>
      </div>
      <div class="col-12 mb-3">
        <label for="fecha_aplicacion" class="form-label">ğŸ§´ Fecha de AplicaciÃ³n *</label>
        <input type="date" name="fecha_aplicacion" id="fecha_aplicacion" class="form-control form-control-lg">
        <div class="form-text">Fecha en que se aplica el producto</div>
      </div>
    </div>

    <!-- HectÃ¡reas y Precio -->
    <div class="row">
      <div class="col-12 mb-3">
        <label for="hectareas" class="form-label">ğŸ“ HectÃ¡reas Estimadas *</label>
        <input type="number" step="0.01" name="hectareas" id="hectareas" class="form-control form-control-lg" required>
      </div>
      <div class="col-12 mb-3">
        <label for="precio_hectarea" class="form-label">ğŸ’² Precio por HectÃ¡rea ($)</label>
        <input type="number" step="0.01" name="precio_hectarea" id="precio_hectarea" class="form-control form-control-lg" value="0.00">
        <div class="form-text">Costo del servicio por hectÃ¡rea</div>
      </div>
    </div>

    <!-- Productos a aplicar -->
    <h5 class="mt-4">ğŸ§ª Productos a Aplicar</h5>
    <div class="table-responsive">
      <table class="table table-bordered align-middle">
        <thead class="table-light">
          <tr>
            <th>Producto / Detalle</th>
            <th>Dosis por Ha</th>
            <th>Unidad</th>
            <th>Total</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="tabla-productos">
          <tr>
            <td><input type="text" name="producto[]" class="form-control form-control-lg" placeholder="Ej: Glifosato, Herbicida, etc."></td>
            <td><input type="number" step="0.01" name="dosis[]" class="form-control form-control-lg" value="0.00"></td>
            <td>
              <select name="unidad[]" class="form-select form-select-lg">
                <option value="litros">Litros</option>
                <option value="kg">Kg</option>
                <option value="cc">cc</option>
              </select>
            </td>
            <td><input type="text" class="form-control form-control-lg total" disabled placeholder="Auto"></td>
            <td><button type="button" class="btn btn-danger btn-lg" onclick="this.closest('tr').remove()">ğŸ—‘ï¸</button></td>
          </tr>
        </tbody>
      </table>
    </div>

    <button type="button" class="btn btn-outline-primary btn-lg w-100 mb-4" onclick="agregarFila()">â• Agregar Producto</button>

    <div class="mb-3">
      <label for="producto_aplicado" class="form-label">ğŸ§ª Producto Aplicado (resumen)</label>
      <input type="text" name="producto_aplicado" id="producto_aplicado" class="form-control form-control-lg" placeholder="Ej: Glifosato, Herbicida, etc.">
      <div class="form-text">PodÃ©s escribir un resumen general si no usÃ¡s la tabla</div>
    </div>

    <!-- Observaciones -->
    <div class="mb-3">
      <label for="observaciones" class="form-label">ğŸ“ Observaciones</label>
      <textarea name="observaciones" id="observaciones" class="form-control form-control-lg" rows="3"></textarea>
    </div>

    <!-- BotÃ³n de envÃ­o -->
    <div class="text-end">
      <button type="submit" class="btn btn-success btn-lg w-100">ğŸ’¾ Guardar Orden de Trabajo</button>
    </div>
  </form>
</div>

<!-- Scripts -->
<script>
function agregarFila() {
  const fila = `
    <tr>
      <td><input type="text" name="producto[]" class="form-control form-control-lg" placeholder="Ej: Glifosato, Herbicida, etc."></td>
      <td><input type="number" step="0.01" name="dosis[]" class="form-control form-control-lg" value="0.00"></td>
      <td>
        <select name="unidad[]" class="form-select form-select-lg">
          <option value="litros">Litros</option>
          <option value="kg">Kg</option>
          <option value="cc">cc</option>
        </select>
      </td>
      <td><input type="text" class="form-control form-control-lg total" disabled placeholder="Auto"></td>
      <td><button type="button" class="btn btn-danger btn-lg" onclick="this.closest('tr').remove()">ğŸ—‘ï¸</button></td>
    </tr>`;
  document.getElementById('tabla-productos').insertAdjacentHTML('beforeend', fila);
  calcularTotales();
}

function calcularTotales() {
  const hectareas = parseFloat(document.getElementById('hectareas').value) || 0;
  const filas = document.querySelectorAll('#tabla-productos tr');

  filas.forEach(fila => {
    const dosisInput = fila.querySelector('input[name="dosis[]"]');
    const totalInput = fila.querySelector('.total');

    if (dosisInput && totalInput) {
      const dosis = parseFloat(dosisInput.value) || 0;
      const total = (hectareas * dosis).toFixed(2);
      totalInput.value = total;
    }
  });
}

document.getElementById('hectareas').addEventListener('input', calcularTotales);
document.getElementById('tabla-productos').addEventListener('input', function(e) {
  if (e.target.name === 'dosis[]') {
    calcularTotales();
  }
});
</script>
{% endblock %}
